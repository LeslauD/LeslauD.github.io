<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.99.1" />
    <meta name="description" content="">


    <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />

    <title>TensorFlow :: 刘顿的博客</title>

    
    <link href="/css/nucleus.css?1659414501" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1659414501" rel="stylesheet">
    <link href="/css/hybrid.css?1659414501" rel="stylesheet">
    <link href="/css/featherlight.min.css?1659414501" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1659414501" rel="stylesheet">
    <link href="/css/auto-complete.css?1659414501" rel="stylesheet">
    <link href="/css/atom-one-dark-reasonable.css?1659414501" rel="stylesheet">
    <link href="/css/theme.css?1659414501" rel="stylesheet">
    <link href="/css/tabs.css?1659414501" rel="stylesheet">
    <link href="/css/hugo-theme.css?1659414501" rel="stylesheet">
    
    <link href="/css/theme-blue.css?1659414501" rel="stylesheet">
    
    

    <script src="/js/jquery-3.3.1.min.js?1659414501"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="/deeplearning/tensorflow/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <img src="/images/keeprush.png">

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1659414501"></script>
<script type="text/javascript" src="/js/auto-complete.js?1659414501"></script>
<script type="text/javascript">
    
        var baseurl = "http:\/\/example.org\/";
    
</script>
<script type="text/javascript" src="/js/search.js?1659414501"></script>

    
  </div>
  
    <section id="homelinks">
      <ul>
        <li>
            <a class="padding" href='/'><i class='fas fa-home'></i> Home</a>
        </li>
      </ul>
    </section>
  

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/resume/" title="个人简历" class="dd-item
        
        
        
        ">
      <a href="/resume/">
          <b></b>个人简历
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/photograph/" title="摄影" class="dd-item
        
        
        
        ">
      <a href="/photograph/">
          <b></b>摄影
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/algorithm/" title="数据结构与算法" class="dd-item
        
        
        
        ">
      <a href="/algorithm/">
          <b></b>数据结构与算法
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/algorithm/leetcode/" title="LeetCode" class="dd-item
        
        
        
        ">
      <a href="/algorithm/leetcode/">
          LeetCode
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/algorithm/newcoder/" title="NewCoder" class="dd-item
        
        
        
        ">
      <a href="/algorithm/newcoder/">
          NewCoder
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/algorithm/pat/" title="PAT" class="dd-item
        
        
        
        ">
      <a href="/algorithm/pat/">
          PAT
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/algorithm/tooffer/" title="剑指Offer" class="dd-item
        
        
        
        ">
      <a href="/algorithm/tooffer/">
          剑指Offer
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/algorithm/datastruct/" title="数据结构" class="dd-item
        
        
        
        ">
      <a href="/algorithm/datastruct/">
          数据结构
          
      </a>
      
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/machinelearning/" title="机器学习" class="dd-item
        
        
        
        ">
      <a href="/machinelearning/">
          <b></b>机器学习
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/machinelearning/recommendedsystem/" title="RecommendedSystem" class="dd-item
        
        
        
        ">
      <a href="/machinelearning/recommendedsystem/">
          RecommendedSystem
          
      </a>
      
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/deeplearning/" title="深度学习" class="dd-item
        parent
        
        
        ">
      <a href="/deeplearning/">
          <b></b>深度学习
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/deeplearning/tensorflow/" title="TensorFlow" class="dd-item
        parent
        active
        
        ">
      <a href="/deeplearning/tensorflow/">
          TensorFlow
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/deeplearning/basic/" title="基础算法理论" class="dd-item
        
        
        
        ">
      <a href="/deeplearning/basic/">
          基础算法理论
          
      </a>
      
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/vehicle/" title="车车" class="dd-item
        
        
        
        ">
      <a href="/vehicle/">
          <b></b>车车
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/vehicle/santana/" title="1:18 Santana" class="dd-item
        
        
        
        ">
      <a href="/vehicle/santana/">
          1:18 Santana
          
      </a>
      
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/piano/" title="钢琴" class="dd-item
        
        
        
        ">
      <a href="/piano/">
          <b></b>钢琴
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/piano/summer/" title="summer" class="dd-item
        
        
        
        ">
      <a href="/piano/summer/">
          <b></b>summer
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/piano/cannon/" title="卡农" class="dd-item
        
        
        
        ">
      <a href="/piano/cannon/">
          <b></b>卡农
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/piano/basic/" title="基本乐理" class="dd-item
        
        
        
        ">
      <a href="/piano/basic/">
          <b></b>基本乐理
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/piano/sunrise/" title="太阳照常升起" class="dd-item
        
        
        
        ">
      <a href="/piano/sunrise/">
          <b></b>太阳照常升起
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/piano/littlestar/" title="小星星变奏曲" class="dd-item
        
        
        
        ">
      <a href="/piano/littlestar/">
          <b></b>小星星变奏曲
          
      </a>
      
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/programs/" title="项目" class="dd-item
        
        
        
        ">
      <a href="/programs/">
          <b></b>项目
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/programs/bodyassessment/" title="BodyAssessment" class="dd-item
        
        
        
        ">
      <a href="/programs/bodyassessment/">
          <b></b>BodyAssessment
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/programs/bodyassessment/imageprocess/" title="ImageProcess" class="dd-item
        
        
        
        ">
      <a href="/programs/bodyassessment/imageprocess/">
          ImageProcess
          
      </a>
      
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/programs/joyyourmind/" title="JoyYourMind" class="dd-item
        
        
        
        ">
      <a href="/programs/joyyourmind/">
          <b></b>JoyYourMind
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/programs/millenniumtemple/" title="MillenniumTemple" class="dd-item
        
        
        
        ">
      <a href="/programs/millenniumtemple/">
          <b></b>MillenniumTemple
          
      </a>
      
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/cxx/" title="CPP" class="dd-item
        
        
        
        ">
      <a href="/cxx/">
          <b></b>CPP
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/cxx/clang/" title="C language" class="dd-item
        
        
        
        ">
      <a href="/cxx/clang/">
          C language
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/cxx/cpp/" title="CPP" class="dd-item
        
        
        
        ">
      <a href="/cxx/cpp/">
          CPP
          
      </a>
      
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/bigdata/" title="大数据" class="dd-item
        
        
        
        ">
      <a href="/bigdata/">
          <b></b>大数据
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/bigdata/hadoop/" title="Hadoop" class="dd-item
        
        
        
        ">
      <a href="/bigdata/hadoop/">
          Hadoop
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/bigdata/spark/" title="Spark" class="dd-item
        
        
        
        ">
      <a href="/bigdata/spark/">
          Spark
          
      </a>
      
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
        
    </ul>

    
    

    
    <section id="footer">
      <p>Built with <a href="https://github.com/matcornic/hugo-theme-learn"><i class="fas fa-heart"></i></a> from <a href="https://getgrav.org">Grav</a> and <a href="https://gohugo.io/">Hugo</a></p>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            <a href='/'></a> > <a href='/deeplearning/'>深度学习</a> > TensorFlow
          
        
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#tensorflow安装">TensorFlow安装</a></li>
        <li><a href="#tensorflow实现线性回归预测波士顿房价">TensorFlow实现线性回归预测波士顿房价</a></li>
        <li><a href="#tensorflow实现softmax回归来识别mnist手写数字">TensorFlow实现Softmax回归来识别MNIST手写数字</a></li>
        <li><a href="#dnnmnist">DNN——MNIST</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              TensorFlow
            </h1>
          

        



	<p><a href="https://www.tensorflow.org">www.tensorflow.org</a></p>
<h3 id="tensorflow安装">TensorFlow安装</h3>
<p>显卡型号：</p>
<img src="/images/1050ti.png">
<h4 id="cpu版本">CPU版本</h4>
<ol start="0">
<li>Windows需要VS环境，安装<a href="https://www.microsoft.com/en-us/download/details.aspx?id=48145">vc_redist.x64.exe</a></li>
<li>在 C:\Users(用户名)目录下，创建一个 pip 文件夹，创建一个 pip.ini 文件， 里面就写 [global] index-url = <a href="https://pypi.tuna.tsinghua.edu.cn/simple">https://pypi.tuna.tsinghua.edu.cn/simple</a></li>
<li>cmd 进入到 anaconda 的 scripts 脚本文件夹所在的位置，去使用命令行去安装 ./pip install &ndash;upgrade</li>
</ol>
<img src="/images/tf.png">
<h4 id="gpu版本">GPU版本</h4>
<p><a href="https://www.tensorflow.org/install/gpu">https://www.tensorflow.org/install/gpu</a></p>
<ol>
<li>
<p>查看NVIDIA显卡驱动</p>
<img src="/images/nvidia.png">
</li>
<li>
<p>安装对应版本的CUDA==11.1</p>
<p><a href="https://developer.nvidia.com/cuda-toolkit-archive">https://developer.nvidia.com/cuda-toolkit-archive</a></p>
<img src="/images/nvcc.png">
</li>
<li>
<p>安装cudnn对应的版本</p>
</li>
</ol>
<p>​		https://developer.nvidia.com/rdp/cudnn-archive</p>
<p>​		cudnn下载完毕之后无需安装，解压之后打开文件夹</p>
<p>​		将其复制到，CUDA安装目录下，与bin目录同级，并改名为cudnn</p>
<ol start="4">
<li>安装tensorflow-gpu</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>pip install tensorflow-gpu<span style="color:#f92672">==</span>2.5.0  <span style="color:#75715e">#要与cuda11.1版本适配</span>
</span></span></code></pre></div><ol start="5">
<li>
<p>验证是否安装成功</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> tensorflow <span style="color:#66d9ef">as</span> tf
</span></span><span style="display:flex;"><span>tf<span style="color:#f92672">.</span>test<span style="color:#f92672">.</span>gpu_device_name()
</span></span><span style="display:flex;"><span>tf<span style="color:#f92672">.</span>config<span style="color:#f92672">.</span>list_physical_devices(<span style="color:#e6db74">&#39;GPU&#39;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#39;GPU&#39;</span>,tf<span style="color:#f92672">.</span>test<span style="color:#f92672">.</span>is_gpu_available())
</span></span></code></pre></div><img src="/images/tf_gpu.png">
</li>
</ol>
<br>
<h3 id="tensorflow实现线性回归预测波士顿房价">TensorFlow实现线性回归预测波士顿房价</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">预测波士顿房价
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">字段说明：
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">CRIM: 城镇人均犯罪率
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ZN：住宅用地超过25000 sq.ft. 的比例
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">INDUS: 城镇非零售商用土地的比例
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">CHAS: 边界是河流为1，否则0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">NOX: 一氧化氮浓度
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">RM: 住宅平均房间数数据集解读
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">AGE: 1940年之前建成的自用房屋比例
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">DIS：到波士顿5个中心区域的加权距离
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">RAD:辐射性公路的靠近指数
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">TAX : 每10000美元的全值财产税率
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">PTRATIO: 城镇师生比例
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LSTAT: 人口中地位低下者的比例
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MEDV: 自住房的平均房价，单位：千美元
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas <span style="color:#66d9ef">as</span> pd
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#66d9ef">as</span> plt
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sklearn.utils <span style="color:#f92672">import</span> shuffle
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sklearn.preprocessing <span style="color:#f92672">import</span> scale
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sklearn.model_selection <span style="color:#f92672">import</span> train_test_split
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> tensorflow <span style="color:#66d9ef">as</span> tf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 保证sess.run()能够正常运行</span>
</span></span><span style="display:flex;"><span>tf<span style="color:#f92672">.</span>compat<span style="color:#f92672">.</span>v1<span style="color:#f92672">.</span>disable_eager_execution()
</span></span><span style="display:flex;"><span>tf<span style="color:#f92672">.</span>compat<span style="color:#f92672">.</span>v1<span style="color:#f92672">.</span>enable_eager_execution(
</span></span><span style="display:flex;"><span>    config<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>    device_policy<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>    execution_mode<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 读取数据</span>
</span></span><span style="display:flex;"><span>df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(<span style="color:#e6db74">&#34;./housing.csv&#34;</span>, header<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>print(df<span style="color:#f92672">.</span>describe())
</span></span><span style="display:flex;"><span>print(df<span style="color:#f92672">.</span>head(<span style="color:#ae81ff">5</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 划分数据集</span>
</span></span><span style="display:flex;"><span>x <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>values[:, :<span style="color:#ae81ff">12</span>]
</span></span><span style="display:flex;"><span>y <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>values[:, <span style="color:#ae81ff">12</span>]
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;x shape: &#34;</span>, x<span style="color:#f92672">.</span>shape)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;y shape: &#34;</span>, y<span style="color:#f92672">.</span>shape)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 划分训练集、验证集、测试集</span>
</span></span><span style="display:flex;"><span>x_train, x_test, y_train, y_test <span style="color:#f92672">=</span> train_test_split(x, y, test_size<span style="color:#f92672">=</span><span style="color:#ae81ff">0.2</span>, random_state<span style="color:#f92672">=</span><span style="color:#ae81ff">2019</span>)
</span></span><span style="display:flex;"><span>x_train, x_valid, y_train, y_valid <span style="color:#f92672">=</span> train_test_split(x_train, y_train, test_size<span style="color:#f92672">=</span><span style="color:#ae81ff">0.2</span>, random_state<span style="color:#f92672">=</span><span style="color:#ae81ff">2019</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 转换数据类型</span>
</span></span><span style="display:flex;"><span>x_train <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>cast(scale(x_train), dtype<span style="color:#f92672">=</span>tf<span style="color:#f92672">.</span>float32)
</span></span><span style="display:flex;"><span>x_valid <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>cast(scale(x_valid), dtype<span style="color:#f92672">=</span>tf<span style="color:#f92672">.</span>float32)
</span></span><span style="display:flex;"><span>x_test <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>cast(scale(x_test), dtype<span style="color:#f92672">=</span>tf<span style="color:#f92672">.</span>float32)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 定义模型</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">model</span>(x, w, b):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> tf<span style="color:#f92672">.</span>matmul(x, w) <span style="color:#f92672">+</span> b           <span style="color:#75715e"># wx+b</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 初始化参数w,b</span>
</span></span><span style="display:flex;"><span>W <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>Variable(tf<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>normal([<span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">1</span>], mean<span style="color:#f92672">=</span><span style="color:#ae81ff">0.0</span>, stddev<span style="color:#f92672">=</span><span style="color:#ae81ff">1.0</span>, dtype<span style="color:#f92672">=</span>tf<span style="color:#f92672">.</span>float32))
</span></span><span style="display:flex;"><span>B <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>Variable(tf<span style="color:#f92672">.</span>zeros(<span style="color:#ae81ff">1</span>), dtype<span style="color:#f92672">=</span>tf<span style="color:#f92672">.</span>float32)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 模型训练</span>
</span></span><span style="display:flex;"><span>epochs <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>lr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.001</span>
</span></span><span style="display:flex;"><span>batch_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 定义损失函数</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">loss</span>(x, y, w, b):
</span></span><span style="display:flex;"><span>    err <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>square(model(x, w, b)<span style="color:#f92672">-</span>y)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> tf<span style="color:#f92672">.</span>reduce_mean(err)              <span style="color:#75715e"># 均方误差</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 定义梯度计算函数</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">grad</span>(x, y, w, b):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>GradientTape() <span style="color:#66d9ef">as</span> tape:
</span></span><span style="display:flex;"><span>        loss_ <span style="color:#f92672">=</span> loss(x, y, w, b)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> tape<span style="color:#f92672">.</span>gradient(loss_, [w, b])     <span style="color:#75715e"># 求loss对w和b的偏导</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 选择优化器</span>
</span></span><span style="display:flex;"><span>optimizer <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>optimizers<span style="color:#f92672">.</span>SGD(lr)     <span style="color:#75715e"># 随机梯度下降</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 迭代训练</span>
</span></span><span style="display:flex;"><span>loss_list_train <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>loss_list_valid <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>total_step <span style="color:#f92672">=</span> int(x_train<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">/</span>batch_size)   <span style="color:#75715e"># 一轮有多少步：训练集个数/一个批次的个数</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> epoch <span style="color:#f92672">in</span> range(epochs):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> step <span style="color:#f92672">in</span> range(total_step):
</span></span><span style="display:flex;"><span>        xs <span style="color:#f92672">=</span> x_train[step<span style="color:#f92672">*</span>batch_size:(step<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">*</span>batch_size,:]
</span></span><span style="display:flex;"><span>        ys <span style="color:#f92672">=</span> y_train[step<span style="color:#f92672">*</span>batch_size:(step<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">*</span>batch_size]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        grads <span style="color:#f92672">=</span> grad(xs, ys, W, B)
</span></span><span style="display:flex;"><span>        optimizer<span style="color:#f92672">.</span>apply_gradients(zip(grads, [W, B]))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    loss_train <span style="color:#f92672">=</span> loss(x_train, y_train, W, B)<span style="color:#f92672">.</span>numpy()
</span></span><span style="display:flex;"><span>    loss_valid <span style="color:#f92672">=</span> loss(x_valid, y_valid, W, B)<span style="color:#f92672">.</span>numpy()
</span></span><span style="display:flex;"><span>    loss_list_train<span style="color:#f92672">.</span>append(loss_train)
</span></span><span style="display:flex;"><span>    loss_list_valid<span style="color:#f92672">.</span>append(loss_valid)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;epoch=</span><span style="color:#e6db74">{:3d}</span><span style="color:#e6db74">,train_loss=</span><span style="color:#e6db74">{:.4f}</span><span style="color:#e6db74">,valid_loss=</span><span style="color:#e6db74">{:.4f}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(epoch<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>, loss_train, loss_valid))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 可视化loss</span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#34;epochs&#34;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#34;loss&#34;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>plot(loss_list_train, <span style="color:#e6db74">&#39;blue&#39;</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;train loss&#34;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>plot(loss_list_valid, <span style="color:#e6db74">&#39;red&#39;</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;valid loss&#34;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>legend(loc<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>show()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 测试集</span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Test_loss:</span><span style="color:#e6db74">{:.4f}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(loss(x_test, y_test, W, B)<span style="color:#f92672">.</span>numpy()))
</span></span><span style="display:flex;"><span>test_house_id <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">0</span>, x_test<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>y <span style="color:#f92672">=</span> y_test[test_house_id]
</span></span><span style="display:flex;"><span>y_predict <span style="color:#f92672">=</span> model(x_test, W, B)[test_house_id]
</span></span><span style="display:flex;"><span>y_predict<span style="color:#f92672">=</span>tf<span style="color:#f92672">.</span>reshape(y_predict, ())<span style="color:#f92672">.</span>numpy()
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;House id : &#34;</span>, test_house_id, <span style="color:#e6db74">&#34;Actual value : &#34;</span>, y, <span style="color:#e6db74">&#34;Predicted value : &#34;</span>, y_predict)
</span></span></code></pre></div><h3 id="tensorflow实现softmax回归来识别mnist手写数字">TensorFlow实现Softmax回归来识别MNIST手写数字</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> tensorflow <span style="color:#66d9ef">as</span> tf
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#66d9ef">as</span> plt
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sklearn.preprocessing <span style="color:#f92672">import</span> OneHotEncoder
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sklearn.model_selection <span style="color:#f92672">import</span> train_test_split
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tf<span style="color:#f92672">.</span>compat<span style="color:#f92672">.</span>v1<span style="color:#f92672">.</span>disable_eager_execution()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 读取数据</span>
</span></span><span style="display:flex;"><span>mnist <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>datasets<span style="color:#f92672">.</span>mnist
</span></span><span style="display:flex;"><span>(x_train, y_train), (x_test, y_test) <span style="color:#f92672">=</span> mnist<span style="color:#f92672">.</span>load_data()
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>title(str(y_train[<span style="color:#ae81ff">0</span>]))
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>imshow(x_train[<span style="color:#ae81ff">0</span>], cmap<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;gray&#34;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>show()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 将图片数据压缩成一维的</span>
</span></span><span style="display:flex;"><span>x_train_ <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>zeros((x_train<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>], <span style="color:#ae81ff">784</span>))
</span></span><span style="display:flex;"><span>x_test_ <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>zeros((x_test<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>], <span style="color:#ae81ff">784</span>))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(x_train<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>]):
</span></span><span style="display:flex;"><span>    x_train_[i] <span style="color:#f92672">=</span> x_train[i]<span style="color:#f92672">.</span>reshape(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(x_test<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>]):
</span></span><span style="display:flex;"><span>    x_test_[i]<span style="color:#f92672">.</span>reshape(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>x_train, x_test <span style="color:#f92672">=</span> x_train_, x_test_
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 将label进行OneHot编码</span>
</span></span><span style="display:flex;"><span>encoder <span style="color:#f92672">=</span> OneHotEncoder(sparse<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>y_train <span style="color:#f92672">=</span> encoder<span style="color:#f92672">.</span>fit_transform(y_train<span style="color:#f92672">.</span>reshape(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>y_test <span style="color:#f92672">=</span> encoder<span style="color:#f92672">.</span>fit_transform(y_test<span style="color:#f92672">.</span>reshape(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 输入的是一堆图片，None表示不限输入条数，784表示每张图片都是一个784个像素值的一维向量</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 所以输入的矩阵是None乘以784二维矩阵</span>
</span></span><span style="display:flex;"><span>x <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>compat<span style="color:#f92672">.</span>v1<span style="color:#f92672">.</span>placeholder(dtype<span style="color:#f92672">=</span>tf<span style="color:#f92672">.</span>float32, shape<span style="color:#f92672">=</span>(<span style="color:#66d9ef">None</span>, <span style="color:#ae81ff">784</span>))    <span style="color:#75715e"># m*784</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 初始化都是0，二维矩阵784乘以10个W值</span>
</span></span><span style="display:flex;"><span>w <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>Variable(tf<span style="color:#f92672">.</span>compat<span style="color:#f92672">.</span>v1<span style="color:#f92672">.</span>random_uniform([<span style="color:#ae81ff">784</span>, <span style="color:#ae81ff">10</span>]))             <span style="color:#75715e"># 784*10</span>
</span></span><span style="display:flex;"><span>b <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>Variable(tf<span style="color:#f92672">.</span>zeros([<span style="color:#ae81ff">10</span>]))                                     <span style="color:#75715e"># 偏置项</span>
</span></span><span style="display:flex;"><span>y_pred <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>softmax(tf<span style="color:#f92672">.</span>matmul(x, w) <span style="color:#f92672">+</span> b)                         <span style="color:#75715e"># x*w+b,激活函数为softmax</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># labels是每张图片都对应一个one-hot的10个值的向量</span>
</span></span><span style="display:flex;"><span>y <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>compat<span style="color:#f92672">.</span>v1<span style="color:#f92672">.</span>placeholder(dtype<span style="color:#f92672">=</span>tf<span style="color:#f92672">.</span>float32, shape<span style="color:#f92672">=</span>(<span style="color:#66d9ef">None</span>, <span style="color:#ae81ff">10</span>))
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 多分类问题常用交叉熵损失函数</span>
</span></span><span style="display:flex;"><span>cross_entropy <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>reduce_mean(<span style="color:#f92672">-</span>tf<span style="color:#f92672">.</span>reduce_sum(y<span style="color:#f92672">*</span>tf<span style="color:#f92672">.</span>compat<span style="color:#f92672">.</span>v1<span style="color:#f92672">.</span>log(y_pred), axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>train_step <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>compat<span style="color:#f92672">.</span>v1<span style="color:#f92672">.</span>train<span style="color:#f92672">.</span>GradientDescentOptimizer(<span style="color:#ae81ff">0.01</span>)<span style="color:#f92672">.</span>minimize(cross_entropy)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 评估</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># tf.argmax()是一个从tensor中寻找最大值的序号，tf.argmax就是求各个预测的数字中概率最大的那一个</span>
</span></span><span style="display:flex;"><span>correct_prediction <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>equal(tf<span style="color:#f92672">.</span>argmax(y_pred, <span style="color:#ae81ff">1</span>), tf<span style="color:#f92672">.</span>argmax(y, <span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 用tf.cast将之前correct_prediction输出的bool值转换为float32，再求平均</span>
</span></span><span style="display:flex;"><span>accuracy <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>reduce_mean(tf<span style="color:#f92672">.</span>cast(correct_prediction, tf<span style="color:#f92672">.</span>float32))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 划分训练集和验证集</span>
</span></span><span style="display:flex;"><span>x_train, x_valid, y_train, y_valid <span style="color:#f92672">=</span> train_test_split(x_train, y_train, test_size<span style="color:#f92672">=</span><span style="color:#ae81ff">0.15</span>)
</span></span><span style="display:flex;"><span>print(x_train<span style="color:#f92672">.</span>shape, y_train<span style="color:#f92672">.</span>shape)
</span></span><span style="display:flex;"><span>print(x_valid<span style="color:#f92672">.</span>shape, y_valid<span style="color:#f92672">.</span>shape)
</span></span><span style="display:flex;"><span>print(x_test<span style="color:#f92672">.</span>shape, y_test<span style="color:#f92672">.</span>shape)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>batch_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 初始化变量</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>compat<span style="color:#f92672">.</span>v1<span style="color:#f92672">.</span>Session() <span style="color:#66d9ef">as</span> sess:
</span></span><span style="display:flex;"><span>    tf<span style="color:#f92672">.</span>compat<span style="color:#f92672">.</span>v1<span style="color:#f92672">.</span>global_variables_initializer()<span style="color:#f92672">.</span>run()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">10000</span>):
</span></span><span style="display:flex;"><span>        random_index <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>choice(x_train<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>], batch_size)     <span style="color:#75715e"># 随机选择batch_size个数据</span>
</span></span><span style="display:flex;"><span>        batch_xs, batch_ys <span style="color:#f92672">=</span> x_train[random_index], y_train[random_index]
</span></span><span style="display:flex;"><span>        sess<span style="color:#f92672">.</span>run(train_step, feed_dict<span style="color:#f92672">=</span>{x: batch_xs, y: batch_ys})
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;TrainSet batch acc : </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">  &#34;</span> <span style="color:#f92672">%</span> accuracy<span style="color:#f92672">.</span>eval({x: batch_xs, y: batch_ys}))
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;ValidSet acc : </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> accuracy<span style="color:#f92672">.</span>eval({x: x_valid, y: y_valid}))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 测试</span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;TestSet acc : </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> accuracy<span style="color:#f92672">.</span>eval({x: x_test, y: y_test}))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 总结</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1，定义算法公式，也就是神经网络forward时的计算</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2，定义loss，选定优化器，并指定优化器优化loss</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3，迭代地对数据进行训练</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 4，在测试集或验证集上对准确率进行评测</span>
</span></span></code></pre></div><h3 id="dnnmnist">DNN——MNIST</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> tensorflow <span style="color:#66d9ef">as</span> tf
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> tensorflow.examples.tutorials.mnist <span style="color:#f92672">import</span> input_data
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> tensorflow.contrib.layers <span style="color:#f92672">import</span> fully_connected
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> tensorflow.contrib.layers <span style="color:#f92672">import</span> conv2d
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> tensorflow.contrib.framework <span style="color:#f92672">import</span> arg_scope
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 构建图阶段</span>
</span></span><span style="display:flex;"><span>n_inputs <span style="color:#f92672">=</span> <span style="color:#ae81ff">28</span><span style="color:#f92672">*</span><span style="color:#ae81ff">28</span>
</span></span><span style="display:flex;"><span>n_hidden1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">300</span>
</span></span><span style="display:flex;"><span>n_hidden2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>n_hidden3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">50</span>
</span></span><span style="display:flex;"><span>n_outputs <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>X <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>placeholder(tf<span style="color:#f92672">.</span>float32, shape<span style="color:#f92672">=</span>(<span style="color:#66d9ef">None</span>, n_inputs), name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;X&#39;</span>)
</span></span><span style="display:flex;"><span>y <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>placeholder(tf<span style="color:#f92672">.</span>int64, shape<span style="color:#f92672">=</span>(<span style="color:#66d9ef">None</span>,), name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;y&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 构建神经网络</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>name_scope(<span style="color:#e6db74">&#34;dnn&#34;</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> arg_scope([fully_connected],   				                                 weights_regularizer<span style="color:#f92672">=</span>tf<span style="color:#f92672">.</span>contrib<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>l2_regularizer(scale<span style="color:#f92672">=</span><span style="color:#ae81ff">0.1</span>)):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># tensorflow使用这个函数帮助我们使用合适的初始化w和b的策略，默认使用ReLU激活函数</span>
</span></span><span style="display:flex;"><span>        hidden1 <span style="color:#f92672">=</span> fully_connected(X, n_hidden1, scope<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;hidden1&#34;</span>)
</span></span><span style="display:flex;"><span>        hidden2 <span style="color:#f92672">=</span> fully_connected(hidden1, n_hidden2, scope<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;hidden2&#34;</span>)
</span></span><span style="display:flex;"><span>        hidden3 <span style="color:#f92672">=</span> fully_connected(hidden2, n_hidden3, scope<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;hidden3&#34;</span>)
</span></span><span style="display:flex;"><span>        logits <span style="color:#f92672">=</span> fully_connected(hidden3, n_outputs, scope<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;outputs&#34;</span>, activation_fn<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>name_scope(<span style="color:#e6db74">&#34;loss&#34;</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 定义交叉熵损失函数，并且求个样本平均</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 函数等价于先使用softmax损失函数，再接着计算交叉熵，并且更有效率</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 类似的softmax_cross_entropy_with_logits只会给one-hot编码，我们使用的会给0-9分类号</span>
</span></span><span style="display:flex;"><span>    xentropy <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>sparse_softmax_cross_entropy_with_logits(labels<span style="color:#f92672">=</span>y, logits<span style="color:#f92672">=</span>logits)
</span></span><span style="display:flex;"><span>    loss <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>reduce_mean(xentropy, name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;loss&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># reg_losses = tf.get_collection(tf.GraphKeys.REGULARIZATION_LOSSES)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># total_loss = tf.add_n([loss] + reg_losses)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>learning_rate <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.01</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>name_scope(<span style="color:#e6db74">&#34;train&#34;</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># optimizer = tf.train.GradientDescentOptimizer(learning_rate)</span>
</span></span><span style="display:flex;"><span>    optimizer <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>train<span style="color:#f92672">.</span>AdamOptimizer(learning_rate)
</span></span><span style="display:flex;"><span>    training_op <span style="color:#f92672">=</span> optimizer<span style="color:#f92672">.</span>minimize(loss)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>name_scope(<span style="color:#e6db74">&#34;eval&#34;</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 获取logits里面最大的那1位和y比较类别好是否相同，返回True或者False一组值</span>
</span></span><span style="display:flex;"><span>    correct <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>in_top_k(logits, y, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    accuracy <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>reduce_mean(tf<span style="color:#f92672">.</span>cast(correct, tf<span style="color:#f92672">.</span>float32))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>init <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>global_variables_initializer()
</span></span><span style="display:flex;"><span>saver <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>train<span style="color:#f92672">.</span>Saver()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 计算图阶段</span>
</span></span><span style="display:flex;"><span>mnist <span style="color:#f92672">=</span> input_data<span style="color:#f92672">.</span>read_data_sets(<span style="color:#e6db74">&#34;MNIST_data_bak/&#34;</span>)
</span></span><span style="display:flex;"><span>n_epochs <span style="color:#f92672">=</span> <span style="color:#ae81ff">400</span>
</span></span><span style="display:flex;"><span>batch_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">50</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>Session() <span style="color:#66d9ef">as</span> sess:
</span></span><span style="display:flex;"><span>    init<span style="color:#f92672">.</span>run()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> epoch <span style="color:#f92672">in</span> range(n_epochs):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> iteration <span style="color:#f92672">in</span> range(mnist<span style="color:#f92672">.</span>train<span style="color:#f92672">.</span>num_examples <span style="color:#f92672">//</span> batch_size):
</span></span><span style="display:flex;"><span>            X_batch, y_batch <span style="color:#f92672">=</span> mnist<span style="color:#f92672">.</span>train<span style="color:#f92672">.</span>next_batch(batch_size)
</span></span><span style="display:flex;"><span>            sess<span style="color:#f92672">.</span>run([training_op], feed_dict<span style="color:#f92672">=</span>{X: X_batch, y: y_batch})
</span></span><span style="display:flex;"><span>        acc_train <span style="color:#f92672">=</span> accuracy<span style="color:#f92672">.</span>eval(feed_dict<span style="color:#f92672">=</span>{X: X_batch, y: y_batch})
</span></span><span style="display:flex;"><span>        acc_test <span style="color:#f92672">=</span> accuracy<span style="color:#f92672">.</span>eval(feed_dict<span style="color:#f92672">=</span>{X: mnist<span style="color:#f92672">.</span>test<span style="color:#f92672">.</span>images,
</span></span><span style="display:flex;"><span>                                            y: mnist<span style="color:#f92672">.</span>test<span style="color:#f92672">.</span>labels})
</span></span><span style="display:flex;"><span>        print(epoch, <span style="color:#e6db74">&#34;Train accuracy:&#34;</span>, acc_train, <span style="color:#e6db74">&#34;Test accuracy:&#34;</span>, acc_test)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    save_path <span style="color:#f92672">=</span> saver<span style="color:#f92672">.</span>save(sess, <span style="color:#e6db74">&#34;./my_dnn_model_final.ckpt&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用模型预测</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> tf<span style="color:#f92672">.</span>Session <span style="color:#66d9ef">as</span> sess:
</span></span><span style="display:flex;"><span>    saver<span style="color:#f92672">.</span>restore(sess, <span style="color:#e6db74">&#34;./my_dnn_model_final.ckpt&#34;</span>)
</span></span><span style="display:flex;"><span>    X_new_scaled <span style="color:#f92672">=</span> [<span style="color:#f92672">...</span>]
</span></span><span style="display:flex;"><span>    Z <span style="color:#f92672">=</span> logits<span style="color:#f92672">.</span>eval(feed_dict<span style="color:#f92672">=</span>{X: X_new_scaled})
</span></span><span style="display:flex;"><span>    y_pred <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>argmax(Z, axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)  <span style="color:#75715e"># 查看最大的类别是哪个</span>
</span></span></code></pre></div>




<footer class=" footline" >
	
</footer>

<script type="text/javascript"
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>